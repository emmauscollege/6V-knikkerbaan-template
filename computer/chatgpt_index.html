<!DOCTYPE html>
<!-- source: https://chatgpt.com/share/6749e82b-1150-8012-b611-5a417ffcad11 -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Counter and Switch</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <script>
    let db;
    let port;
    let reader;

    async function initDatabase() {
      const SQL = await initSqlJs();
      const dbData = localStorage.getItem('sqliteDB');
      if (dbData) {
        db = new SQL.Database(new Uint8Array(JSON.parse(dbData)));
      } else {
        db = new SQL.Database();
        db.run(`
          CREATE TABLE settings (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            counter INTEGER DEFAULT 0
          );
          INSERT INTO settings (counter) VALUES (0);
        `);
      }
      updateUI();
    }

    function updateUI() {
      const result = db.exec('SELECT counter FROM settings');
      const counter = result[0].values[0][0];
      const switchPosition = counter % 2 === 0 ? 'left' : 'right';

      document.getElementById('counter').innerText = `Counter: ${counter}`;
      document.getElementById('switch').innerText = `Switch: ${switchPosition}`;
    }

    function saveDatabase() {
      const data = JSON.stringify(Array.from(db.export()));
      localStorage.setItem('sqliteDB', data);
    }

    function incrementCounter() {
      db.run('UPDATE settings SET counter = counter + 1');
      saveDatabase();
      updateUI();
    }

    async function connectSerial() {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 9600 });

        const decoder = new TextDecoderStream();
        const inputDone = port.readable.pipeTo(decoder.writable);
        const inputStream = decoder.readable;
        reader = inputStream.getReader();

        readSerialData();
      } catch (error) {
        console.error('Error connecting to serial port:', error);
      }
    }

    async function readSerialData() {
      while (true) {
        try {
          const { value, done } = await reader.read();
          if (done) {
            console.log('Serial port closed.');
            reader.releaseLock();
            break;
          }
          if (value.trim() === 'knikker') {
            incrementCounter();
          }
        } catch (error) {
          console.error('Error reading from serial port:', error);
          break;
        }
      }
    }

    async function disconnectSerial() {
      if (reader) {
        await reader.cancel();
        reader.releaseLock();
      }
      if (port) {
        await port.close();
      }
      console.log('Serial port disconnected.');
    }

    window.onload = () => {
      initDatabase();

      document.getElementById('connect').addEventListener('click', connectSerial);
      document.getElementById('disconnect').addEventListener('click', disconnectSerial);
    };
  </script>
</head>
<body>
  <h1>Serial Port Counter</h1>
  <p id="counter">Loading...</p>
  <p id="switch">Loading...</p>
  <button id="connect">Connect to Serial Port</button>
  <button id="disconnect">Disconnect</button>
</body>
</html>
